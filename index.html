<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic-Tac-Toe Game</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide-static@latest/font/Lucide.ttf"></script>
    <style>
        /* Import Lucide font */
        @font-face {
          font-family: 'LucideIcons';
          src: url('https://cdn.jsdelivr.net/npm/lucide-static@latest/font/Lucide.ttf') format('truetype');
        }

        /* Styles are largely unchanged */
        /* ... (CSS Styles from previous version) ... */
        /* Global Variables & Themes */
        :root {
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --font-icons: 'LucideIcons';
            --transition-speed: 0.3s;

            /* Light Theme (Default) */
            --bg-color: #f0f0f0;
            --text-color: #333;
            --board-bg: #fff;
            --cell-bg: #fff;
            --cell-border: #ccc;
            --cell-hover-bg: #e9e9e9;
            --button-bg: #e0e0e0;
            --button-text-color: #333;
            --button-hover-bg: #d0d0d0;
            --score-bg: #e0e0e0;
            --x-color: #3498db; /* Blue */
            --o-color: #e74c3c; /* Red */
            --win-line-color: #2ecc71; /* Green */
            --icon-color: #555;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --board-gap: 0px;
            --cell-radius: 8px;
            --x-weight: bold;
            --o-weight: bold;
            --o-border-width: 0px;
            --score-box-p1-bg: transparent;
            --score-box-ties-bg: transparent;
            --score-box-p2-bg: transparent;
            --score-box-p1-text: var(--text-color);
            --score-box-ties-text: var(--text-color);
            --score-box-p2-text: var(--text-color);
            --score-box-radius: 10px;
            --score-padding: 15px 0;
            --top-bar-bg: transparent;
            --theme-btn-light-bg: #ffffff;
            --theme-btn-dark-bg: #2c3e50;
            --theme-btn-deluxe-bg: #14b8a6;
            --theme-btn-udeluxe-bg: #34495e;
            --theme-btn-text: var(--text-color);
            /* Auth Screen Specific */
            --auth-bg: #ffffff;
            --auth-input-border: #d1d5db;
            --auth-input-focus-border: #4f46e5; /* Indigo */
            --auth-button-login-bg: #3b82f6; /* Blue */
            --auth-button-login-hover-bg: #2563eb;
            --auth-button-signup-bg: #10b981; /* Green */
            --auth-button-signup-hover-bg: #059669;
            --guest-button-bg: transparent;
            --guest-button-text: #6b7280; /* Gray */
            --guest-button-border: #d1d5db;
            --guest-button-hover-bg: #f3f4f6; /* Light Gray */
            --error-color: #dc2626; /* Red */
            --success-color: #16a34a; /* Green */
            --signup-input-focus-border-alpha: rgba(79, 70, 229, 0.2);
        }

        [data-theme="dark"] {
            --bg-color: #2c3e50;
            --text-color: #ecf0f1;
            --board-bg: #34495e;
            --cell-bg: #34495e;
            --cell-border: #4a6178;
            --cell-hover-bg: #41566b;
            --button-bg: #4a6178;
            --button-text-color: #ecf0f1;
            --button-hover-bg: #5d7a99;
            --score-bg: #34495e;
            --x-color: #5dade2;
            --o-color: #f1948a;
            --win-line-color: #58d68d;
            --icon-color: #bdc3c7;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --cell-radius: 8px;
            --score-box-p1-text: var(--text-color);
            --score-box-ties-text: var(--text-color);
            --score-box-p2-text: var(--text-color);
            --theme-btn-text: #ecf0f1;
             /* Auth Specific */
            --auth-bg: #374151; /* Dark Gray */
            --auth-input-border: #6b7280;
            --auth-input-focus-border: #60a5fa; /* Lighter Blue */
            --guest-button-text: #d1d5db; /* Light Gray */
            --guest-button-border: #6b7280;
            --guest-button-hover-bg: #4b5563; /* Darker Gray */
            --signup-input-focus-border-alpha: rgba(96, 165, 250, 0.3);
        }

        [data-theme="deluxe"] {
            --bg-color: #14b8a6;
            --text-color: #ffffff;
            --board-bg: #14b8a6;
            --cell-bg: #0f766e;
            --cell-border: transparent;
            --cell-hover-bg: #115e59;
            --button-bg: #0d9488;
            --button-text-color: #ffffff;
            --button-hover-bg: #0f766e;
            --score-bg: transparent;
            --x-color: #ffffff;
            --o-color: #ffffff;
            --win-line-color: #ffffff;
            --icon-color: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --board-gap: 8px;
            --cell-radius: 10px;
            --x-weight: lighter;
            --o-weight: lighter;
            --score-box-p1-bg: transparent;
            --score-box-ties-bg: transparent;
            --score-box-p2-bg: transparent;
            --score-box-radius: 0px;
            --score-padding: 0;
            --theme-btn-text: #ffffff;
            /* Auth Specific */
            --auth-bg: #ccfbf1; /* Very Light Mint */
            --auth-input-border: #5eead4;
            --auth-input-focus-border: #14b8a6;
            --auth-button-login-bg: #0d9488;
            --auth-button-login-hover-bg: #0f766e;
            --auth-button-signup-bg: #047857;
            --auth-button-signup-hover-bg: #065f46;
            --guest-button-text: #0f766e;
            --guest-button-border: #5eead4;
            --guest-button-hover-bg: #99f6e4;
             --signup-input-focus-border-alpha: rgba(20, 184, 166, 0.3);
        }

        [data-theme="u-deluxe"] {
            --bg-color: #2c3e50;
            --text-color: #ecf0f1;
            --board-bg: #2c3e50;
            --cell-bg: #34495e;
            --cell-border: transparent;
            --cell-hover-bg: #4a6178;
            --button-bg: #34495e;
            --button-text-color: #ecf0f1;
            --button-hover-bg: #4a6178;
            --score-bg: transparent;
            --x-color: #48c9b0;
            --o-color: #f1c40f;
            --win-line-color: #e74c3c;
            --icon-color: #bdc3c7;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --board-gap: 10px;
            --cell-radius: 12px;
            --x-weight: bold;
            --o-weight: bold;
            --o-border-width: 8px;
            --score-box-p1-bg: #48c9b0;
            --score-box-ties-bg: #bdc3c7;
            --score-box-p2-bg: #f1c40f;
            --score-box-p1-text: #ffffff;
            --score-box-ties-text: #2c3e50;
            --score-box-p2-text: #2c3e50;
            --score-box-radius: 8px;
            --score-padding: 0;
            --top-bar-bg: var(--button-bg);
            --theme-btn-text: #ecf0f1;
            /* Auth Specific */
             --auth-bg: #374151; /* Dark Gray */
             --auth-input-border: #6b7280;
             --auth-input-focus-border: #48c9b0; /* Teal */
             --auth-button-login-bg: #48c9b0; /* Teal */
             --auth-button-login-hover-bg: #5eead4;
             --auth-button-signup-bg: #f1c40f; /* Yellow */
             --auth-button-signup-hover-bg: #f59e0b;
             --guest-button-text: #d1d5db;
             --guest-button-border: #6b7280;
             --guest-button-hover-bg: #4b5563;
             --signup-input-focus-border-alpha: rgba(72, 201, 176, 0.3);
        }

        /* Base Styles */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
        }

        /* Screen Styling */
        .screen {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 20px;
            overflow-y: auto; position: absolute; top: 0; left: 0;
            opacity: 1; visibility: visible;
            transition: opacity var(--transition-speed) ease, visibility var(--transition-speed) ease;
        }
        .screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

        /* --- Homepage Styles --- */
        #home-screen { background-color: #4f46e5; color: #ffffff; justify-content: space-around; text-align: center; }
        .home-title { font-size: clamp(3em, 15vmin, 6em); font-weight: bold; line-height: 1; margin-bottom: 10px; animation: fadeInDown 0.8s ease forwards; }
        .home-title span { display: block; }
        .home-graphic { width: min(60vw, 250px); height: min(60vw, 250px); background-color: #ffffff; border-radius: 50% 50% 45% 55% / 60% 55% 45% 40%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #4f46e5; font-size: clamp(3em, 18vmin, 7em); font-weight: bold; position: relative; animation: zoomIn 0.8s 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; opacity: 0; transform: scale(0.8); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .home-graphic .xo { line-height: 1; } .home-graphic .xo .o { margin-left: -0.1em; }
        .home-graphic::after { content: ')'; position: absolute; bottom: 15%; font-size: 0.3em; transform: rotate(90deg); opacity: 0.7; }
        #play-button { padding: 15px 40px; font-size: 1.2em; font-weight: bold; background-color: #6366f1; color: #ffffff; border: none; border-radius: 30px; cursor: pointer; transition: background-color var(--transition-speed) ease, transform 0.2s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.2); animation: fadeInUp 0.8s 0.6s ease forwards; opacity: 0; }
        #play-button:hover { background-color: #818cf8; transform: translateY(-3px); }
        #play-button:active { transform: translateY(0); }

        /* --- Auth Screen Styles --- */
        #auth-screen { /* Uses standard screen centering */ }
        .auth-container {
            background-color: var(--auth-bg);
            color: var(--text-color);
            padding: 30px; border-radius: 12px;
            box-shadow: 0 10px 25px var(--shadow-color);
            width: 100%; max-width: 400px; text-align: center;
        }
        .auth-container h2 { font-size: 1.8em; font-weight: 600; margin-bottom: 25px; color: var(--text-color); }
        #auth-message { text-align: center; padding: 10px; margin-bottom: 15px; border-radius: 6px; font-weight: 500; display: none; }
        #auth-message.error { background-color: var(--error-color); color: white; display: block; }
        #auth-message.success { background-color: var(--success-color); color: white; display: block; }
        .auth-input-group { margin-bottom: 20px; text-align: left; }
        .auth-input-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9em; }
        .auth-input-group input { width: 100%; padding: 10px 12px; border: 1px solid var(--auth-input-border); border-radius: 8px; font-size: 1em; background-color: var(--cell-bg); color: var(--text-color); transition: border-color var(--transition-speed) ease; }
        .auth-input-group input:focus { outline: none; border-color: var(--auth-input-focus-border); box-shadow: 0 0 0 2px var(--signup-input-focus-border-alpha); }
        .auth-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .auth-buttons button { padding: 12px; font-size: 1em; font-weight: 600; border-radius: 8px; cursor: pointer; transition: background-color var(--transition-speed) ease, transform 0.15s ease, border-color var(--transition-speed) ease, color var(--transition-speed) ease; border: none; width: 100%; }
        #login-button { background-color: var(--auth-button-login-bg); color: white; }
        #login-button:hover { background-color: var(--auth-button-login-hover-bg); transform: translateY(-1px); }
        #signup-button { background-color: var(--auth-button-signup-bg); color: white; }
        #signup-button:hover { background-color: var(--auth-button-signup-hover-bg); transform: translateY(-1px); }
        #guest-play-button { background-color: var(--guest-button-bg); color: var(--guest-button-text); border: 2px solid var(--guest-button-border); font-weight: 500; }
        #guest-play-button:hover { background-color: var(--guest-button-hover-bg); transform: translateY(-1px); }
        .auth-buttons button:disabled { background-color: #9ca3af !important; color: #e5e7eb !important; border-color: #9ca3af !important; cursor: not-allowed; transform: none; } /* Important to override theme colors */
        .auth-info { font-size: 0.8em; color: var(--text-color); opacity: 0.7; margin-top: 15px; }

        /* --- Game Screen Styles --- */
        #game-screen { justify-content: space-between; }
        .icon { font-family: var(--font-icons); font-size: 1.3em; line-height: 1; display: inline-block; color: var(--icon-color); transition: transform var(--transition-speed) ease, color var(--transition-speed) ease; vertical-align: middle; }
        button .icon { margin-right: 5px; } button.icon-only .icon { margin-right: 0; } button:hover .icon { transform: scale(1.1) rotate(5deg); }
        .container { width: 100%; max-width: 500px; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .game-header { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 500px; padding: 5px 0; margin-bottom: 5px; font-size: 0.9em; }
        .user-info { color: var(--text-color); opacity: 0.8; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: calc(100% - 80px); /* Prevent overlap */ }
        #logout-button { background: none; border: none; color: var(--o-color); cursor: pointer; padding: 5px; display: flex; align-items: center; gap: 4px; font-size: 0.9em; font-weight: 500; }
        #logout-button .icon { font-size: 1.1em; } #logout-button:hover { color: var(--error-color); }
        #game-screen:not(.logged-in) .game-header { display: none; }
        [data-theme="u-deluxe"] .game-header { display: none; }
        [data-theme="u-deluxe"] .top-bar .user-info { margin-right: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 150px; }
        [data-theme="u-deluxe"] .top-bar #logout-button-topbar { order: 3; color: var(--o-color); } /* Move logout after reset */
        [data-theme="u-deluxe"] .top-bar #logout-button-topbar:hover { color: var(--error-color); }

        .top-bar { display: none; width: 100%; justify-content: space-between; align-items: center; padding: 10px 15px; border-radius: 10px; margin-bottom: 10px; background-color: var(--top-bar-bg); box-shadow: 0 4px 10px var(--shadow-color); animation: slideInDown 0.5s ease forwards; }
        [data-theme="u-deluxe"] .top-bar { display: flex; }
        .logo { font-size: 1.8em; font-weight: bold; } .logo .x { color: var(--x-color); } .logo .o { color: var(--o-color); }
        .turn-indicator { display: flex; align-items: center; gap: 8px; background-color: rgba(0,0,0,0.1); padding: 8px 15px; border-radius: 8px; font-weight: bold; transition: background-color var(--transition-speed) ease; }
        .turn-indicator .text { animation: pulse 1.5s infinite ease-in-out; }
        [data-theme="u-deluxe"] .status#status, [data-theme="u-deluxe"] #reset-button.main-reset { display: none; }
        .top-bar #reset-button { padding: 10px; box-shadow: none; background-color: transparent; } .top-bar #reset-button:hover { background-color: rgba(255, 255, 255, 0.1); }
        h1 { margin-bottom: 10px; font-size: 2.5em; font-weight: bold; animation: fadeInDown 0.5s ease forwards; text-align: center; }
        [data-theme="deluxe"] h1, [data-theme="u-deluxe"] h1 { display: none; }
        .settings { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 10px 15px; margin-bottom: 15px; animation: fadeInUp 0.5s 0.2s ease forwards; opacity: 0; width: 100%; }
        .setting-group { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .setting-group.theme-buttons { width: 100%; flex-direction: row; justify-content: center; gap: 8px; }
        label { font-weight: bold; font-size: 0.9em; opacity: 0.8; }
        select, button:not(#login-button):not(#signup-button):not(#guest-play-button):not(#play-button):not(#logout-button):not(#logout-button-topbar) { /* Exclude auth/guest/play/logout buttons */
             padding: 8px 12px; border-radius: 8px; border: none; background-color: var(--button-bg); color: var(--button-text-color); font-family: var(--font-main); font-size: 0.9em; cursor: pointer; transition: background-color var(--transition-speed) ease, transform 0.2s ease, box-shadow var(--transition-speed) ease; box-shadow: 0 3px 6px var(--shadow-color);
        }
        select { appearance: none; padding-right: 25px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23${(props) => props.theme.iconColor.substring(1)}' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 8px center; background-size: 12px 12px; }
        select:focus, button:not(#login-button):not(#signup-button):not(#guest-play-button):not(#play-button):not(#logout-button):not(#logout-button-topbar):focus { outline: 2px solid var(--x-color); outline-offset: 2px; }
        button:not(#login-button):not(#signup-button):not(#guest-play-button):not(#play-button):not(#logout-button):not(#logout-button-topbar):hover { background-color: var(--button-hover-bg); transform: translateY(-2px) scale(1.02); box-shadow: 0 5px 10px var(--shadow-color); }
        button:not(#login-button):not(#signup-button):not(#guest-play-button):not(#play-button):not(#logout-button):not(#logout-button-topbar):active { transform: translateY(0) scale(0.98); box-shadow: 0 2px 4px var(--shadow-color); }
        .theme-buttons button { padding: 8px 18px; font-size: 0.85em; font-weight: bold; line-height: 1; border-radius: 999px; border: 2px solid rgba(0,0,0,0.1); color: var(--theme-btn-text); }
        #light-theme-btn { background-color: var(--theme-btn-light-bg); border-color: #ccc; color: #333; }
        #dark-theme-btn { background-color: var(--theme-btn-dark-bg); } #deluxe-theme-btn { background-color: var(--theme-btn-deluxe-bg); } #u-deluxe-theme-btn { background-color: var(--theme-btn-udeluxe-bg); }
        .theme-buttons button:hover { filter: brightness(1.1); }
        .theme-buttons button.active { outline: 3px solid var(--win-line-color); outline-offset: 1px; box-shadow: 0 0 10px var(--win-line-color); }
        .board { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); width: min(80vw, 350px); height: min(80vw, 350px); margin: 5px auto; background-color: var(--board-bg); border-radius: 10px; position: relative; overflow: hidden; animation: zoomIn 0.6s 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; opacity: 0; transform: scale(0.8); gap: var(--board-gap); padding: var(--board-gap); border: 1px solid var(--cell-border); }
        :root:not([data-theme="deluxe"]):not([data-theme="u-deluxe"]) .board { padding: 0; border: none; }
        .cell { width: 100%; height: 100%; border: 1px solid var(--cell-border); display: flex; align-items: center; justify-content: center; font-size: clamp(2em, 10vmin, 4.5em); font-weight: bold; cursor: pointer; transition: background-color var(--transition-speed) ease, transform 0.2s ease; position: relative; background-color: var(--cell-bg); color: transparent; border-radius: var(--cell-radius); overflow: hidden; }
        :root:not([data-theme="deluxe"]):not([data-theme="u-deluxe"]) .cell:nth-child(3n) { border-right: none; } :root:not([data-theme="deluxe"]):not([data-theme="u-deluxe"]) .cell:nth-child(1), :root:not([data-theme="deluxe"]):not([data-theme="u-deluxe"]) .cell:nth-child(2), :root:not([data-theme="deluxe"]):not([data-theme="u-deluxe"]) .cell:nth-child(3) { border-top: none; } :root:not([data-theme="deluxe"]):not([data-theme="u-deluxe"]) .cell:nth-child(7), :root:not([data-theme="deluxe"]):not([data-theme="u-deluxe"]) .cell:nth-child(8), :root:not([data-theme="deluxe"]):not([data-theme="u-deluxe"]) .cell:nth-child(9) { border-bottom: none; } :root:not([data-theme="deluxe"]):not([data-theme="u-deluxe"]) .cell:nth-child(1), :root:not([data-theme="deluxe"]):not([data-theme="u-deluxe"]) .cell:nth-child(4), :root:not([data-theme="deluxe"]):not([data-theme="u-deluxe"]) .cell:nth-child(7) { border-left: none; }
        [data-theme="deluxe"] .cell, [data-theme="u-deluxe"] .cell { border: none; }
        .cell:not(.occupied):hover { background-color: var(--cell-hover-bg); transform: scale(1.05); z-index: 1; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        .cell.occupied { cursor: not-allowed; transform: scale(1); } .cell.occupied:hover { box-shadow: none; }
        .cell.x::before, .cell.o::before { position: absolute; display: flex; align-items: center; justify-content: center; width: 70%; height: 70%; animation: symbolAppear 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); line-height: 1; }
        .cell.x::before { content: 'X'; color: var(--x-color); font-weight: var(--x-weight); }
        .cell.o::before { content: ''; color: var(--o-color); font-weight: var(--o-weight); border: var(--o-border-width) solid var(--o-color); border-radius: 50%; box-sizing: border-box; }
        :root:not([data-theme="u-deluxe"]) .cell.o::before { content: 'O'; border: none; }
        .win-line { position: absolute; background-color: var(--win-line-color); height: 8px; border-radius: 4px; transform-origin: 0 50%; animation: drawLine 0.6s ease-out forwards; display: none; z-index: 2; box-shadow: 0 0 10px var(--win-line-color); pointer-events: none; }
        .scoreboard { display: flex; justify-content: space-around; width: 100%; max-width: 450px; margin-top: 10px; padding: var(--score-padding); background-color: var(--score-bg); border-radius: var(--score-box-radius); box-shadow: 0 -4px 10px var(--shadow-color); transition: background-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; animation: fadeInUp 0.5s 0.6s ease forwards; opacity: 0; gap: 10px; }
        .score { text-align: center; padding: 10px; border-radius: var(--score-box-radius); flex: 1; transition: background-color var(--transition-speed) ease, transform 0.2s ease; animation: scoreAppear 0.3s ease forwards; opacity: 0; animation-delay: calc(var(--index) * 0.1s + 0.7s); }
        .score:nth-child(1) { background-color: var(--score-box-p1-bg); color: var(--score-box-p1-text); --index: 0; } .score:nth-child(2) { background-color: var(--score-box-ties-bg); color: var(--score-box-ties-text); --index: 1; } .score:nth-child(3) { background-color: var(--score-box-p2-bg); color: var(--score-box-p2-text); --index: 2; }
        .score p { font-size: 0.85em; font-weight: bold; opacity: 0.9; margin-bottom: 3px; } .score span { display: block; font-size: 1.6em; font-weight: bold; } .score.updated span { animation: scoreUpdate 0.5s ease; }
        .status { margin-top: 10px; font-size: 1.2em; font-weight: bold; min-height: 1.5em; animation: fadeIn 0.5s ease; text-align: center; }
        #reset-button.main-reset { margin-top: 10px; padding: 10px 20px; font-size: 1em; font-weight: bold; animation: fadeInUp 0.5s 0.8s ease forwards; opacity: 0; }

        /* Animations */
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInDown { from { opacity: 0; transform: translateY(-100%); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes symbolAppear { from { opacity: 0; transform: scale(0.3) rotate(-90deg); } to { opacity: 1; transform: scale(1) rotate(0deg); } }
        @keyframes drawLine { from { transform: scaleX(0); } to { transform: scaleX(1); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } }
        @keyframes scoreAppear { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0px); } }
        @keyframes scoreUpdate { 0% { transform: scale(1); } 50% { transform: scale(1.2); color: var(--win-line-color); } 100% { transform: scale(1); } }

        /* Media Queries */
        @media (max-width: 600px) {
            h1 { font-size: 2em; } .container { gap: 10px; } .settings { margin-bottom: 10px; }
            .board { width: min(85vw, 300px); height: min(85vw, 300px); }
            .scoreboard { flex-direction: row; gap: 5px; padding: 5px; max-width: 90%; }
            .score { padding: 8px 5px; } .score p { font-size: 0.75em; } .score span { font-size: 1.4em; }
            .status { font-size: 1.1em; } .top-bar { padding: 8px 10px; } .logo { font-size: 1.5em; }
            .turn-indicator { padding: 6px 10px; font-size: 0.9em; } .theme-buttons button { padding: 6px 12px; font-size: 0.8em; }
            .auth-container { padding: 20px; } .auth-container h2 { font-size: 1.5em; }
        }
         @media (max-width: 400px) {
             body { padding: 0; } .screen { padding: 15px; }
             .board { width: min(90vw, 260px); height: min(90vw, 260px); }
             .cell { font-size: clamp(1.8em, 9vmin, 3.5em); }
             [data-theme="u-deluxe"] .cell.o::before { --o-border-width: 5px; }
             .scoreboard { max-width: 95%; } .score span { font-size: 1.2em; }
             .top-bar { flex-wrap: wrap; justify-content: center; gap: 5px;} .logo { display: none; }
             .settings { gap: 8px; } .theme-buttons button { padding: 5px 10px; font-size: 0.75em; }
             select, button:not(#login-button):not(#signup-button):not(#guest-play-button):not(#play-button):not(#logout-button):not(#logout-button-topbar) { padding: 6px 10px; font-size: 0.85em; }
             .auth-container { max-width: 95%; }
             .auth-buttons button { padding: 10px; font-size: 0.95em; }
         }

    </style>
</head>
<body>

    <div id="home-screen" class="screen">
        <div class="home-title"><span>Tic</span><span>Tac</span><span>Toe</span></div>
        <div class="home-graphic"><span class="xo">X<span class="o">O</span></span></div>
        <button id="play-button">Play</button>
    </div>

    <div id="auth-screen" class="screen hidden">
        <div class="auth-container">
            <h2>Login / Sign Up</h2>
            <div id="auth-message"></div> <div class="auth-input-group">
                <label for="auth-email">Email</label>
                <input type="email" id="auth-email" placeholder="you@example.com" required>
            </div>
            <div class="auth-input-group">
                <label for="auth-password">Password</label>
                <input type="password" id="auth-password" placeholder="••••••••" required>
            </div>
            <div class="auth-buttons">
                <button id="login-button">Login</button>
                <button id="signup-button">Sign Up</button>
                <button id="guest-play-button">Continue as Guest</button>
            </div>
             <p class="auth-info">Password should be at least 6 characters.</p>
        </div>
    </div>


    <div id="game-screen" class="screen hidden">
        <div class="game-header">
            <span class="user-info" id="user-info"></span>
            <button id="logout-button" title="Logout">
                <span id="logout-text">Logout</span>
                <span class="icon" data-lucide="log-out"></span>
            </button>
        </div>

        <div class="container">
             <div class="top-bar">
                <div class="logo"><span class="x">X</span><span class="o">O</span></div>
                <span class="user-info" id="user-info-topbar"></span>
                <div class="turn-indicator" id="turn-indicator"><span class="text"></span></div>
                <button id="reset-button" class="icon-only" title="Reset Game"><span class="icon" data-lucide="rotate-cw"></span></button>
                <button id="logout-button-topbar" title="Logout" class="icon-only">
                     <span class="icon" data-lucide="log-out"></span>
                 </button>
            </div>
            <h1>Tic-Tac-Toe</h1>
            <div class="board" id="board">
                <div class="win-line" id="win-line"></div>
            </div>
            <div class="settings">
                 <div class="setting-group theme-buttons">
                    <button id="light-theme-btn" data-theme="light">Light</button>
                    <button id="dark-theme-btn" data-theme="dark">Dark</button>
                    <button id="deluxe-theme-btn" data-theme="deluxe">Deluxe</button>
                    <button id="u-deluxe-theme-btn" data-theme="u-deluxe">U-Deluxe</button>
                </div>
                <div class="setting-group">
                    <label for="game-mode">Mode:</label>
                    <select id="game-mode"> <option value="ai">Player vs AI</option> <option value="1v1">Player vs Player</option> </select>
                </div>
                <div class="setting-group" id="difficulty-group">
                    <label for="difficulty">Difficulty:</label>
                    <select id="difficulty"> <option value="easy">Easy</option> <option value="medium">Medium</option> <option value="hard">Hard</option> </select>
                </div>
            </div>
            <div class="status" id="status">Player X's Turn</div>
            <button id="reset-button" class="main-reset"><span class="icon" data-lucide="rotate-cw"></span> Reset Game</button>
        </div>
        <div class="scoreboard">
             <div class="score"> <p id="player1-label">X (YOU)</p> <span id="player1-score">0</span> </div>
            <div class="score"> <p id="ties-label">Ties</p> <span id="ties-score">0</span> </div>
            <div class="score"> <p id="player2-label">O (CPU)</p> <span id="player2-score">0</span> </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const homeScreen = document.getElementById('home-screen');
        const authScreen = document.getElementById('auth-screen');
        const gameScreen = document.getElementById('game-screen');
        const playButton = document.getElementById('play-button');
        // Auth Screen Elements (IDs must match HTML)
        const authMessage = document.getElementById('auth-message');
        const emailInput = document.getElementById('auth-email');
        const passwordInput = document.getElementById('auth-password');
        const loginButton = document.getElementById('login-button');
        const signupButton = document.getElementById('signup-button');
        const guestPlayButton = document.getElementById('guest-play-button');
        // Game Screen Elements
        const gameHeader = document.querySelector('.game-header');
        const userInfoDisplay = document.getElementById('user-info');
        const userInfoDisplayTopBar = document.getElementById('user-info-topbar');
        const logoutButton = document.getElementById('logout-button');
        const logoutButtonTopBar = document.getElementById('logout-button-topbar');
        const boardElement = document.getElementById('board');
        const statusElement = document.getElementById('status');
        const turnIndicatorElement = document.getElementById('turn-indicator');
        const turnIndicatorText = turnIndicatorElement?.querySelector('.text'); // Added null check
        const player1ScoreElement = document.getElementById('player1-score');
        const tiesScoreElement = document.getElementById('ties-score');
        const player2ScoreElement = document.getElementById('player2-score');
        const player1LabelElement = document.getElementById('player1-label');
        const tiesLabelElement = document.getElementById('ties-label');
        const player2LabelElement = document.getElementById('player2-label');
        const resetButtons = document.querySelectorAll('#reset-button');
        const gameModeSelect = document.getElementById('game-mode');
        const difficultySelect = document.getElementById('difficulty');
        const difficultyGroup = document.getElementById('difficulty-group');
        const winLineElement = document.getElementById('win-line');
        const themeButtons = document.querySelectorAll('.theme-buttons button');
        const bodyElement = document.body;

        // --- Game State ---
        const PLAYER_X = 'x'; const PLAYER_O = 'o';
        let currentPlayer = PLAYER_X; let boardState = Array(9).fill(null);
        let gameActive = true; let gameMode = 'ai'; let difficulty = 'easy';
        let sessionScores = { x: 0, o: 0, ties: 0 };
        let currentTheme = 'light';
        let currentUser = null;
        let currentUserStats = { wins: 0, losses: 0, ties: 0 };

        // --- Winning Combinations ---
        const winningCombinations = [ [0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8], [0, 4, 8], [2, 4, 6] ];

        // --- Configuration (from TXT file) ---
        const SUPABASE_URL = 'https://mrhrwgydvlnqdjnofavj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1yaHJ3Z3lkdmxucWRqbm9mYXZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM1ODAzNzEsImV4cCI6MjA1OTE1NjM3MX0.dt9wUC4CVu_AQtrS1McCHYjC6rYVibf7VSvxJRK3Ues';

        // --- Supabase Client Initialization (Corrected) ---
        let supabaseClient = null; // Use distinct name for the client instance
        try {
             if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                 throw new Error("Supabase URL or Anon Key is missing.");
             }
            // The global object from CDN is 'supabase'. Call its createClient method.
            // Store the result in 'supabaseClient'.
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log("DEBUG: Supabase client initialized successfully using global supabase object.");

        } catch (error) {
            console.error("DEBUG: Supabase initialization error:", error);
             if (authMessage) {
                 showAuthMessage(error.message || "Could not initialize Supabase. Check console and configuration.", true);
             } else {
                 alert("Could not initialize Supabase. Check console and configuration.");
             }
            if(loginButton) loginButton.disabled = true;
            if(signupButton) signupButton.disabled = true;
        }


        // --- Utility Functions ---
        function showScreen(screenToShow) {
            console.log(`DEBUG: Showing screen: ${screenToShow?.id}`);
            document.querySelectorAll('.screen').forEach(screen => screen.classList.add('hidden'));
            if (screenToShow) screenToShow.classList.remove('hidden');
            else console.error("DEBUG: screenToShow was null or undefined");
        }

        function showAuthMessage(message, isError = false) {
             if (authMessage) {
                 console.log(`DEBUG: Auth Message (${isError ? 'Error' : 'Success'}): ${message}`);
                 authMessage.textContent = message;
                 authMessage.className = 'message'; // Reset class
                 authMessage.classList.add(isError ? 'error' : 'success');
                 authMessage.style.display = 'block';
                 authMessage.id = 'auth-message'; // Ensure ID is correct
             } else {
                  console.error("DEBUG: authMessage element not found!");
             }
         }

        function clearAuthMessages() {
            if (authMessage) authMessage.style.display = 'none';
            else console.warn("DEBUG: authMessage element not found when trying to clear.");
        }

        // --- Database Functions (Still commented out for focus on Auth) ---
        async function fetchUserStats() {
            console.log("DEBUG: fetchUserStats called (DB logic commented out)");
            if (!currentUser) { console.log("DEBUG: No current user, cannot fetch stats."); return; }
            currentUserStats = { wins: 0, losses: 0, ties: 0 }; // Reset local cache
            updateScoreboard(); // Update UI with 0s
            return;

            /* // --- Original DB Logic ---
            if (!currentUser || !supabaseClient) return; // Use supabaseClient
            console.log("Fetching user stats for:", currentUser.id);
            try {
                const { data, error, status } = await supabaseClient.from('profiles').select(`wins, losses, ties`).eq('id', currentUser.id).single(); // Use supabaseClient
                if (error && status !== 406) throw error;
                if (data) {
                    console.log("Stats fetched:", data);
                    currentUserStats = { wins: data.wins || 0, losses: data.losses || 0, ties: data.ties || 0 };
                } else {
                    console.log("No profile found for user, initializing stats locally.");
                    currentUserStats = { wins: 0, losses: 0, ties: 0 };
                    // console.log("Attempting to insert profile...");
                    // const { error: insertError } = await supabaseClient.from('profiles').insert({ id: currentUser.id }); // Use supabaseClient
                    // if (insertError) console.error("Error inserting profile:", insertError);
                }
                updateScoreboard();
            } catch (error) {
                console.error("Error fetching user stats:", error.message);
                currentUserStats = { wins: 0, losses: 0, ties: 0 };
                updateScoreboard();
            }
            */
        }

        async function updateUserStats() {
             console.log("DEBUG: updateUserStats called (DB logic commented out)");
             return;

            /* // --- Original DB Logic ---
            if (!currentUser || !supabaseClient) return; // Use supabaseClient
            console.log("Updating user stats in DB:", currentUserStats);
            try {
                const { error } = await supabaseClient.from('profiles').update({ wins: currentUserStats.wins, losses: currentUserStats.losses, ties: currentUserStats.ties }).eq('id', currentUser.id); // Use supabaseClient
                if (error) throw error;
                console.log("Stats updated successfully in DB.");
            } catch (error) {
                console.error("Error updating user stats:", error.message);
            }
            */
        }


        // --- Authentication Logic (Copied from TXT file, adapted selectors/client name) ---
        async function handleLogin() {
            console.log("DEBUG: handleLogin (from TXT) called");
            clearAuthMessages();
            // Use supabaseClient
            if (!supabaseClient) return showAuthMessage("Supabase client not available.", true);

            // Adapted selectors
            if (!emailInput || !passwordInput) { console.error("DEBUG: Email or Password input not found!"); return showAuthMessage("Input field error.", true); }
            const email = emailInput.value;
            const password = passwordInput.value;

            if (!email || !password) {
                return showAuthMessage("Please enter both email and password.", true);
            }

            try {
                if (loginButton) loginButton.disabled = true;
                if (signupButton) signupButton.disabled = true;
                // Use supabaseClient
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password,
                });

                if (error) {
                    console.error("DEBUG: Login error:", error);
                    showAuthMessage(error.message || "Login failed.", true);
                } else {
                    console.log("DEBUG: Login successful:", data);
                    // UI update handled by onAuthStateChange
                }
            } catch (error) {
                console.error("DEBUG: Unexpected login error:", error);
                showAuthMessage("An unexpected error occurred during login.", true);
            } finally {
                 if (loginButton) loginButton.disabled = false;
                 if (signupButton) signupButton.disabled = false;
            }
        }

        async function handleSignup() {
            console.log("DEBUG: handleSignup (from TXT) called");
            clearAuthMessages();
             // Use supabaseClient
            if (!supabaseClient) return showAuthMessage("Supabase client not available.", true);

            // Adapted selectors
            if (!emailInput || !passwordInput) { console.error("DEBUG: Email or Password input not found!"); return showAuthMessage("Input field error.", true); }
            const email = emailInput.value;
            const password = passwordInput.value;

             if (!email || !password) {
                return showAuthMessage("Please enter both email and password.", true);
            }
             if (password.length < 6) { // Using 6 from TXT file
                 return showAuthMessage("Password should be at least 6 characters.", true);
             }

            try {
                if (loginButton) loginButton.disabled = true;
                if (signupButton) signupButton.disabled = true;
                 // Use supabaseClient
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                });

                if (error) {
                     console.error("DEBUG: Signup error:", error);
                    if (error.message.includes("User already registered")) {
                         showAuthMessage("This email is already registered. Try logging in.", true);
                    } else {
                        showAuthMessage(error.message || "Sign up failed.", true);
                    }
                } else {
                    console.log("DEBUG: Signup attempt result:", data);
                    if (data.user && data.user.identities && data.user.identities.length === 0) {
                        console.log("DEBUG: Signup requires email confirmation.");
                        showAuthMessage("Signup successful! Please check your email to confirm your account.", false);
                    } else if (data.session) {
                        console.log("DEBUG: Signup successful and session created.");
                        showAuthMessage("Signup successful! You are logged in.", false);
                    } else {
                        console.log("DEBUG: Signup successful, confirmation status unclear.");
                        showAuthMessage("Signup successful! Confirmation might be required (check email).", false);
                    }
                }
            } catch (error) {
                console.error("DEBUG: Unexpected signup error:", error);
                showAuthMessage("An unexpected error occurred during sign up.", true);
            } finally {
                 if (loginButton) loginButton.disabled = false;
                 if (signupButton) signupButton.disabled = false;
            }
        }

        async function handleLogout() {
            console.log("DEBUG: handleLogout (from TXT) called");
            clearAuthMessages();
             // Use supabaseClient
            if (!supabaseClient) return;

            // Adapted selectors
            const logoutBtn = document.getElementById('logout-button');
            const logoutBtnTop = document.getElementById('logout-button-topbar');

            try {
                if (logoutBtn) logoutBtn.disabled = true;
                if (logoutBtnTop) logoutBtnTop.disabled = true;
                 // Use supabaseClient
                const { error } = await supabaseClient.auth.signOut();
                if (error) {
                    console.error("DEBUG: Logout error:", error);
                } else {
                    console.log("DEBUG: Logout successful");
                    // UI update handled by onAuthStateChange
                }
            } catch (error) {
                 console.error("DEBUG: Unexpected logout error:", error);
            } finally {
                if (logoutBtn) logoutBtn.disabled = false;
                if (logoutBtnTop) logoutBtnTop.disabled = false;
            }
        }

        // --- Supabase Auth State Change Listener (Adapted from TXT file) ---
        function setupAuthListener() {
             console.log("DEBUG: Setting up Auth Listener (from TXT)...");
              // Use supabaseClient
             if (!supabaseClient) {
                 console.error("DEBUG: Cannot set up auth listener: Supabase client not initialized.");
                 showScreen(authScreen);
                 return;
             }

             // Use supabaseClient
             supabaseClient.auth.onAuthStateChange(async (event, session) => {
                 console.log('DEBUG: Auth State Change Event:', event, 'Session:', session);
                 clearAuthMessages();

                 currentUser = session?.user ?? null;

                 // Selectors adapted for Tic-Tac-Toe UI
                 const authScreenElement = document.getElementById('auth-screen');
                 const gameScreenElement = document.getElementById('game-screen');
                 const userInfoElement = document.getElementById('user-info');
                 const userInfoTopBarElement = document.getElementById('user-info-topbar');
                 const emailInputElement = document.getElementById('auth-email');
                 const passwordInputElement = document.getElementById('auth-password');

                 // Ensure elements exist before manipulating
                 if (!authScreenElement || !gameScreenElement || !userInfoElement || !userInfoTopBarElement || !emailInputElement || !passwordInputElement) {
                     console.error("DEBUG: One or more critical UI elements not found in onAuthStateChange. Aborting UI update.");
                     return;
                 }


                 if (event === 'SIGNED_IN' && session && session.user) {
                     console.log('DEBUG: Event SIGNED_IN - User signed in:', session.user.email);
                     authScreenElement.classList.add('hidden');
                     gameScreenElement.classList.remove('hidden');
                     gameScreenElement.classList.add('logged-in');
                     userInfoElement.textContent = session.user.email;
                     userInfoTopBarElement.textContent = session.user.email;

                     await fetchUserStats(); // Fetch stats (currently logs only)
                     updatePlayerLabels();
                     resetGame();

                 } else if (event === 'SIGNED_OUT') {
                      console.log('DEBUG: Event SIGNED_OUT - User signed out.');
                      authScreenElement.classList.remove('hidden');
                      gameScreenElement.classList.add('hidden');
                      gameScreenElement.classList.remove('logged-in');
                      userInfoElement.textContent = '';
                      userInfoTopBarElement.textContent = '';
                      emailInputElement.value = '';
                      passwordInputElement.value = '';

                      currentUserStats = { wins: 0, losses: 0, ties: 0 };
                      sessionScores = { x: 0, o: 0, ties: 0 };
                      updatePlayerLabels();
                      updateScoreboard();
                 }
             });
              console.log("DEBUG: Auth state change listener (from TXT) set up.");
         }

        // --- Game Logic Functions (Unchanged from previous step) ---
        function createBoard() { /* ... */
             let winLine = boardElement.querySelector('.win-line'); if (!winLine) { winLine = document.createElement('div'); winLine.classList.add('win-line'); winLine.id = 'win-line'; } winLine.style.display = 'none'; boardElement.innerHTML = ''; boardElement.appendChild(winLine);
             for (let i = 0; i < 9; i++) { const cell = document.createElement('div'); cell.classList.add('cell'); cell.dataset.index = i; cell.addEventListener('click', handleCellClick); boardElement.appendChild(cell); }
             boardElement.style.animation = 'none'; void boardElement.offsetWidth; boardElement.style.animation = ''; }
        function handleCellClick(event) { /* ... */
            const index = event.target.dataset.index; if (!gameActive || boardState[index] !== null || (gameMode === 'ai' && currentPlayer === PLAYER_O)) return;
            if (makeMove(index, currentPlayer)) { if (gameActive && gameMode === 'ai' && currentPlayer === PLAYER_O) { boardElement.style.pointerEvents = 'none'; updateStatus("Computer O is thinking..."); setTimeout(() => { aiMove(); if (gameActive) boardElement.style.pointerEvents = 'auto'; }, 600 + Math.random() * 400); } } }
        function makeMove(index, player) { /* ... */
            if (boardState[index] !== null || !gameActive) return false; boardState[index] = player; const cell = boardElement.querySelector(`.cell[data-index='${index}']`); if (cell) cell.classList.add(player, 'occupied'); const winningCombo = checkWin(player);
            if (winningCombo) { drawWinningLine(winningCombo); endGame(false, player); } else if (boardState.every(cellVal => cellVal !== null)) { endGame(true); } else { switchPlayer(); } return true; }
        function switchPlayer() { /* ... */ currentPlayer = currentPlayer === PLAYER_X ? PLAYER_O : PLAYER_X; updateStatus(); }
        function updateStatus(overrideMessage = null) { /* ... */
            let message = ''; let turnText = ''; if (overrideMessage) { message = overrideMessage; turnText = message; } else if (!gameActive) { return; } else { let playerName = gameMode === '1v1' ? `Player ${currentPlayer.toUpperCase()}` : (currentPlayer === PLAYER_X ? 'Your (X)' : 'Computer (O)'); message = `${playerName}'s Turn`; turnText = `${currentPlayer.toUpperCase()} TURN`; } statusElement.textContent = message;
            if (turnIndicatorElement && turnIndicatorText) { turnIndicatorText.textContent = turnText; turnIndicatorElement.className = 'turn-indicator'; if (message.includes('Turn')) turnIndicatorElement.classList.add(`${currentPlayer}-turn`); } }
        function checkWin(player) { /* ... */ return winningCombinations.find(combination => combination.every(index => boardState[index] === player)); }
        function drawWinningLine(combination) { /* ... */
             const startCell = boardElement.querySelector(`.cell[data-index='${combination[0]}']`); const endCell = boardElement.querySelector(`.cell[data-index='${combination[2]}']`); if (!startCell || !endCell || !winLineElement) return; winLineElement.style.display = 'block'; const startX = startCell.offsetLeft + startCell.offsetWidth / 2; const startY = startCell.offsetTop + startCell.offsetHeight / 2; const endX = endCell.offsetLeft + endCell.offsetWidth / 2; const endY = endCell.offsetTop + endCell.offsetHeight / 2; const deltaX = endX - startX; const deltaY = endY - startY; const length = Math.sqrt(deltaX * deltaX + deltaY * deltaY) ; const angle = Math.atan2(deltaY, deltaX) * (180 / Math.PI); winLineElement.style.width = `${length}px`; winLineElement.style.top = `${startY - winLineElement.offsetHeight / 2}px`; winLineElement.style.left = `${startX}px`; winLineElement.style.transform = `rotate(${angle}deg)`; winLineElement.style.transformOrigin = '0% 50%'; winLineElement.style.animation = 'none'; void winLineElement.offsetWidth; winLineElement.style.animation = 'drawLine 0.6s ease-out forwards'; }
        function endGame(draw, winner = null) { /* ... (DB call still commented out) ... */
            if (!gameActive) return; gameActive = false; boardElement.style.pointerEvents = 'none'; let finalMessage = ''; let statsChanged = false;
            if (draw) { finalMessage = "It's a Draw!"; if (currentUser) { currentUserStats.ties++; statsChanged = true; } else { sessionScores.ties++; } triggerScoreUpdate(tiesScoreElement.parentElement);
            } else if (winner) { finalMessage = `Player ${winner.toUpperCase()} Wins!`; if (currentUser) { if (winner === PLAYER_X) currentUserStats.wins++; else currentUserStats.losses++; statsChanged = true; } else { if (winner === PLAYER_X) sessionScores.x++; else sessionScores.o++; } if(winner === PLAYER_X) triggerScoreUpdate(player1ScoreElement.parentElement); else triggerScoreUpdate(player2ScoreElement.parentElement); winningCombinations.forEach(combination => { if (combination.every(index => boardState[index] === winner)) { combination.forEach(index => { const cell = boardElement.querySelector(`.cell[data-index='${index}']`); if(cell) cell.style.filter = 'brightness(0.8)'; }); } }); }
            updateStatus(finalMessage); updateScoreboard(); if (currentUser && statsChanged) { updateUserStats(); } }
        function triggerScoreUpdate(scoreBoxElement) { /* ... */ if (!scoreBoxElement) return; const span = scoreBoxElement.querySelector('span'); if (!span) return; span.classList.add('updated'); span.addEventListener('animationend', () => span.classList.remove('updated'), { once: true }); }
        function updateScoreboard() { /* ... */
            if (!player1ScoreElement || !tiesScoreElement || !player2ScoreElement) { console.error("DEBUG: Scoreboard elements not found!"); return; }
            if (currentUser) { player1ScoreElement.textContent = currentUserStats.wins; tiesScoreElement.textContent = currentUserStats.ties; player2ScoreElement.textContent = currentUserStats.losses; }
            else { player1ScoreElement.textContent = sessionScores.x; tiesScoreElement.textContent = sessionScores.ties; player2ScoreElement.textContent = sessionScores.o; } }
        function resetGame() { /* ... */
            console.log("DEBUG: resetGame called"); currentPlayer = PLAYER_X; boardState = Array(9).fill(null); gameActive = true; if(winLineElement) winLineElement.style.display = 'none'; if(boardElement) boardElement.style.pointerEvents = 'auto'; else { console.error("DEBUG: boardElement not found in resetGame"); return; } const cells = boardElement.querySelectorAll('.cell'); cells.forEach(cell => { cell.classList.remove(PLAYER_X, PLAYER_O, 'occupied'); cell.style.filter = 'none'; });
            updateStatus(); updateScoreboard(); updatePlayerLabels();
             if (gameScreen && !gameScreen.classList.contains('hidden')) { document.querySelectorAll('#game-screen .settings, #game-screen .board, #game-screen .scoreboard, #game-screen #reset-button.main-reset, #game-screen .top-bar, #game-screen .game-header').forEach(el => { if (window.getComputedStyle(el).display !== 'none') { el.style.animation = 'none'; void el.offsetWidth; el.style.animation = ''; } }); document.querySelectorAll('#game-screen .score').forEach((el, index) => { el.style.animation = 'none'; void el.offsetWidth; el.style.setProperty('--index', index); el.style.animation = 'scoreAppear 0.3s ease forwards'; el.style.animationDelay = `calc(var(--index) * 0.1s + 0.3s)`; }); } }
        function updatePlayerLabels() { /* ... */
             if (!player1LabelElement || !tiesLabelElement || !player2LabelElement) { console.error("DEBUG: Scoreboard label elements not found!"); return; }
            if (currentUser) { player1LabelElement.textContent = "Your Wins"; tiesLabelElement.textContent = "Ties"; player2LabelElement.textContent = gameMode === 'ai' ? "CPU Wins" : "P2 Wins"; }
            else { player1LabelElement.textContent = gameMode === 'ai' ? "X (YOU)" : "Player X"; tiesLabelElement.textContent = "Ties"; player2LabelElement.textContent = gameMode === 'ai' ? "O (CPU)" : "Player O"; } }
        function handleModeChange() { /* ... */ if (!gameModeSelect || !difficultyGroup) return; gameMode = gameModeSelect.value; difficultyGroup.style.display = gameMode === 'ai' ? 'flex' : 'none'; if (gameMode === 'ai') difficulty = difficultySelect.value; resetGame(); }
        function handleDifficultyChange() { /* ... */ if (!difficultySelect) return; difficulty = difficultySelect.value; }
        function handleThemeChange(theme) { /* ... */ if (!bodyElement || !themeButtons) return; currentTheme = theme; bodyElement.dataset.theme = theme; themeButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.theme === theme)); localStorage.setItem('ticTacToeTheme', theme); }
        // --- AI Logic (Unchanged) ---
        function aiMove(){if(!gameActive||currentPlayer!==PLAYER_O)return;let bestMove;switch(difficulty){case'easy':bestMove=getRandomMove();break;case'medium':bestMove=getMediumMove();break;case'hard':bestMove=findBestMove();break;default:bestMove=getRandomMove();}if(bestMove!==undefined)makeMove(bestMove,PLAYER_O);else updateStatus();}
        function getRandomMove(){const available=boardState.map((c,i)=>(c===null?i:null)).filter(i=>i!==null);return available.length>0?available[Math.floor(Math.random()*available.length)]:undefined;}
        function getMediumMove(){for(let i=0;i<9;i++){if(boardState[i]===null){boardState[i]=PLAYER_O;if(checkWin(PLAYER_O)){boardState[i]=null;return i;}boardState[i]=null;}} for(let i=0;i<9;i++){if(boardState[i]===null){boardState[i]=PLAYER_X;if(checkWin(PLAYER_X)){boardState[i]=null;return i;}boardState[i]=null;}} if(boardState[4]===null)return 4; return getRandomMove();}
        function findBestMove(){let bestScore=-Infinity;let move;for(let i=0;i<9;i++){if(boardState[i]===null){boardState[i]=PLAYER_O;let score=minimax(boardState,0,false);boardState[i]=null;if(score>bestScore){bestScore=score;move=i;}}} return move!==undefined?move:getRandomMove();}
        const scoresMinimax={[PLAYER_O]:10,[PLAYER_X]:-10,tie:0};
        function minimax(currentBoard,depth,isMaximizing){const winnerX=checkWin(PLAYER_X);if(winnerX)return scoresMinimax[PLAYER_X]+depth;const winnerO=checkWin(PLAYER_O);if(winnerO)return scoresMinimax[PLAYER_O]-depth;if(currentBoard.every(cell=>cell!==null))return scoresMinimax.tie;let bestScore=isMaximizing?-Infinity:Infinity;const player=isMaximizing?PLAYER_O:PLAYER_X;for(let i=0;i<9;i++){if(currentBoard[i]===null){currentBoard[i]=player;let score=minimax(currentBoard,depth+1,!isMaximizing);currentBoard[i]=null;bestScore=isMaximizing?Math.max(score,bestScore):Math.min(score,bestScore);}}return bestScore;}


        // --- Event Listeners Setup ---
        function setupEventListeners() {
            console.log("DEBUG: Setting up event listeners...");

            if (playButton) {
                playButton.addEventListener('click', () => {
                    console.log("DEBUG: Play button clicked");
                    showScreen(authScreen);
                    clearAuthMessages();
                    if (emailInput) emailInput.value = '';
                    if (passwordInput) passwordInput.value = '';
                });
            } else console.error("DEBUG: Play button not found!");

            if (guestPlayButton) {
                 guestPlayButton.addEventListener('click', () => {
                     console.log("DEBUG: Guest Play button clicked");
                     currentUser = null;
                     if(gameScreen) gameScreen.classList.remove('logged-in');
                     sessionScores = { x: 0, o: 0, ties: 0 };
                     updatePlayerLabels();
                     updateScoreboard();
                     showScreen(gameScreen);
                     resetGame();
                 });
            } else console.error("DEBUG: Guest play button not found!");

            if (loginButton) loginButton.addEventListener('click', handleLogin);
            else console.error("DEBUG: Login button not found!");

            if (signupButton) signupButton.addEventListener('click', handleSignup);
            else console.error("DEBUG: Signup button not found!");

            if (logoutButton) logoutButton.addEventListener('click', handleLogout);
            else console.error("DEBUG: Logout button not found!");

            if (logoutButtonTopBar) logoutButtonTopBar.addEventListener('click', handleLogout);
            else console.error("DEBUG: Top bar logout button not found!");


            resetButtons.forEach((button, index) => {
                if (button) button.addEventListener('click', resetGame);
                else console.error(`DEBUG: Reset button at index ${index} not found!`);
            });

            if (gameModeSelect) gameModeSelect.addEventListener('change', handleModeChange);
            else console.error("DEBUG: Game mode select not found!");

            if (difficultySelect) difficultySelect.addEventListener('change', handleDifficultyChange);
            else console.error("DEBUG: Difficulty select not found!");

            themeButtons.forEach((button, index) => {
                if (button) button.addEventListener('click', () => handleThemeChange(button.dataset.theme));
                else console.error(`DEBUG: Theme button at index ${index} not found!`);
            });
             console.log("DEBUG: Event listeners setup complete.");
        }


        // --- Initialization (Adapted from TXT file) ---
        async function initializeApp() {
             console.log("DEBUG: Initializing app (using TXT logic)...");
             const savedTheme = localStorage.getItem('ticTacToeTheme') || 'light';
             handleThemeChange(savedTheme);
             createBoard();

             if (!supabaseClient) { // Check the correct variable name
                  console.error("DEBUG: Initialization failed: Supabase client not available.");
                  showScreen(authScreen);
                  return;
             }

              try {
                 console.log("DEBUG: Checking initial session...");
                 // Use supabaseClient
                 const { data: { session }, error } = await supabaseClient.auth.getSession();
                  console.log("DEBUG: Initial session check complete. Session:", session);

                  if (error) {
                     console.error("DEBUG: Error getting initial session:", error);
                     showAuthMessage("Error checking session: " + error.message, true);
                     showScreen(authScreen);
                 } else if (session && session.user) {
                     console.log("DEBUG: User initially logged in:", session.user.email);
                     // Listener will handle showing gameScreen
                 } else {
                     console.log("DEBUG: User initially logged out.");
                     showScreen(homeScreen); // Start on home screen if logged out
                 }
             } catch (err) {
                  console.error("DEBUG: Unexpected error during initial auth check:", err);
                  showAuthMessage("Initialization error. Check console.", true);
                  showScreen(authScreen);
             } finally {
                  setupEventListeners();
                  setupAuthListener(); // This will trigger based on the initial state checked above
                  console.log("DEBUG: App initialization complete.");
             }

             updatePlayerLabels();
             handleModeChange();

             document.querySelectorAll('.score').forEach((el, index) => {
                 el.style.setProperty('--index', index);
             });
         }


        // --- Run Initialization on DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>
